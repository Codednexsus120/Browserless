name: macos-rdp
on: [workflow_dispatch]

jobs:
  rdp:
    runs-on: macos-latest
    steps:
      - name: Enable Remote Management
        run: |
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
              -activate -configure -access -on \
              -restart -agent -privs -all
          
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
              -configure -clientopts -setvnclegacy -vnclegacy yes
          
          # Optional: Set VNC password if you need macOS legacy access
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
              -configure -clientopts -setvncpw -vncpw rohit198

      - name: Download Pinggy
        run: |
          curl -L -o pinggy https://s3.ap-south-1.amazonaws.com/public.pinggy.binaries/cli/v0.2.5/mac/univ/pinggy
          chmod +x pinggy
          ./pinggy -h || true

      - name: Start Pinggy reverse tunnel (RDP)
        timeout-minutes: 340
        if: always()
        run: |
          ./pinggy -p 443 -R0:localhost:5900 \
            -o StrictHostKeyChecking=no -o ServerAliveInterval=30 \
            K4rdNLZTQe9+tcp@free.pinggy.io
